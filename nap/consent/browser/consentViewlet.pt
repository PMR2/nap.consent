<div id="viewlet-consent" role="alert" style="display: none" tal:attributes="data-enabled view/enabled">
    
  <link href="consent.css" rel="stylesheet" tal:attributes="href string:${view/site_url}/++resource++nap.consent/consent.css">
  <div id="attrs" tal:attributes="src string:${view/site_url}/++resource++nap.consent/ABI-logo.png;
                                  user view/user"></div>
  <div id="intro-consent">
    <div>
      <div class="consent-status">Hi <span tal:content="view/user"></span>!</div>
      <div class="consent-title" tal:content="view/title">Title</div>
      <div class="consent-text" tal:content="structure view/text">Consent</div>
    </div>
    <div class="bts_consent">
      <button name="nap.consent.bt.info" i18n:translate="title_button_info"><span>More Info</span></button>
    </div>
  </div>
  
  <div id="pis-icf-consent">
    <div class="consent-outer">
      <div id="pis-consent" class="left-inner" tal:attributes="url string:${view/site_url}/++resource++nap.consent/PIS.html">This is the PIS</div>
      <div class="separator"></div>
      <div id="icf-consent" class="right-inner" tal:attributes="url string:${view/site_url}/++resource++nap.consent/ICF.html">This is the ICF</div>
      <div "style: clear:both;"></div>
    </div>
    <div class="bts_consent">
      <button class="button_consent" name="nap.consent.bt.disagree" i18n:translate="title_button_agree"><span>Disagree</span></button>
      <button class="button_consent" name="nap.consent.bt.agree" i18n:translate="title_button_agree"><span>Agree</span></button>
    </div>
  </div>

  <style type="text/css">
  .left-inner
    {
	  background-color: #efefef;
	  color: #000;
	  height: 400px;
	  width: 49%;
	  float: left;
      overflow: auto;
	}
    .right-inner
    {
	  background-color: #efefef;
	  color: #000;
	  height: 400px;
	  width: 49%;
      float: right;
      overflow: auto;
    }
    .consent-info {
      background-color: lightblue;
      color: darkblue;
      height: 250px;
      overflow: auto;
      margin-top: 0.5em;
    }
    table.consent_list td.val {
      padding-left:15px;
      padding-top:5px;
      padding-bottom:5px;
    }
    table.consent_list td.num {
      padding-left:30px;
      padding-top:5px;
      padding-bottom:5px;
      vertical-align: top;
    }
    .bts_consent{
      float: right;
    }
    button.button_consent {
      display: inline-block;
      border-radius: 4px;
      background-color: #f4511e;
      border: none;
      color: #FFFFFF;
      text-align: center;
      font-size: 28px;
      padding: 15px;
      width: 200px;
      transition: all 0.5s;
      cursor: pointer;
      margin: 5px;
    }
    button.button_consent span {
      cursor: pointer;
      display: inline-block;
      position: relative;
      transition: 0.5s;
    }
    button.button_consent span:after {
      content: '\00bb';
      position: absolute;
      opacity: 0;
      top: 0;
      right: -20px;
      transition: 0.5s;
    }
    button.button_consent:hover span {
      padding-right: 25px;
    }
    button.button_consent:hover span:after {
      opacity: 1;
      right: 0;
    }
    
    button[name="nap.consent.bt.info"] {
      display: inline-block;
      border-radius: 4px;
      background-color: #f4511e;
      border: none;
      color: #FFFFFF;
      text-align: center;
      font-size: 28px;
      padding: 15px;
      width: 200px;
      transition: all 0.5s;
      cursor: pointer;
      margin: 5px;
    }
    button[name="nap.consent.bt.info"] span {
      cursor: pointer;
      display: inline-block;
      position: relative;
      transition: 0.5s;
    }
    button[name="nap.consent.bt.info"] span:after {
      content: '\00bb';
      position: absolute;
      opacity: 0;
      top: 0;
      right: -20px;
      transition: 0.5s;
    }
    button[name="nap.consent.bt.info"]:hover span {
      padding-right: 25px;
    }
    button[name="nap.consent.bt.info"]:hover span:after {
      opacity: 1;
      right: 0;
    }
  </style>

  <script>
  if (Storage !== undefined) {
    $(document).ready(function () {
      "use strict";

      /** Show consent information when it already activated by admin **/
      var enabled = $("#viewlet-consent").attr("data-enabled");
      if (enabled !== "true") {
        return;
      }
      
      /** public variable declaration **/
      var status = localStorage.getItem("cns-status");
      var user = $("#attrs").attr("user");
      var d = new Date();
      var expireYear = new Date(d.getFullYear() + 1, d.getMonth(), d.getDate());
      
      /** presenting project information based on participation status and action date **/
      /** dissagree user will get offer after 10 days, agree user will rebew after 365 days **/
      if (status === null) {
        $("#viewlet-consent").show();
        $("#pis-icf-consent").hide();
      } else {
        var currDate_ms = (new Date()).getTime();
        var prevDate_ms = (new Date(localStorage.getItem("cns-status-date"))).getTime();
        var diffDate_ms = currDate_ms - prevDate_ms;
        var diffLimit_ms = 1000*60*60*24*10; //10 days limit
        if (status === "activated") {
          diffLimit_ms = 1000*60*60*24*365; //365 days limit
        }
        if (diffDate_ms > diffLimit_ms){
          $("#viewlet-consent").show();
          $("#pis-icf-consent").hide();
        }
      }

      /** Clicking "More Info" button, than loading PIS and ICF forms **/
      $("button[name='nap.consent.bt.info']").click(function (event) {
        event.preventDefault();
        $("#intro-consent").hide();
        var abi_logo = $("#attrs").attr("src");
        var url = $("#pis-consent").attr("url");
        $.get( url, function( data ) {
            data = data.replace("ABI-logo.png",abi_logo);
            $("#pis-consent").html(data);  
        });
        url = $("#icf-consent").attr("url");
        $.get( url, function( data ) {
            data = data.replace("ABI-logo.png",abi_logo);
            $("#icf-consent").html(data);
        });
        $("#pis-icf-consent").show();
      });
      
      /** Disagree to participate into the project **/
      $("button[name='nap.consent.bt.disagree']").click(function (event) {
        event.preventDefault();
        localStorage.setItem("cns-status", "deactivated");
        localStorage.setItem("cns-status-date", new Date());
        document.cookie = "_user=";
        document.cookie = "_login-status=";
        $("#viewlet-consent").hide();
      });
      
      /** Agree to participate into the project **/
      $("button[name='nap.consent.bt.agree']").click(function (event) {
        event.preventDefault();
        localStorage.setItem("cns-status", "activated");
        localStorage.setItem("cns-status-date", new Date());
        $("#viewlet-consent").hide();
        if (user.length === 0){
          document.cookie = "_user=undefined; expires="+expireYear+"; path=/";
          document.cookie = "_login-status=false; path=/";
        } else {
          document.cookie = "_user="+user+"; expires="+expireYear+"; path=/";
          document.cookie = "_login-status=true; path=/";
        }
      });
      
      /** Update login status for activated user **/
      if (status === "activated" && user.length === 0){
        document.cookie = "_login-status=false; path=/";
      } else if (status === "activated" && user.length > 0){
        document.cookie = "_login-status=true; path=/";
        document.cookie = "_user="+user+"; expires="+expireYear+"; path=/";
      }

    });
  }
  </script>

</div>
